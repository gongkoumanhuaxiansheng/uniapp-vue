# 微信小程序云数据库权限配置指南

## 🚨 问题说明

错误 `errCode: -502003 database permission denied` 表明当前用户没有云数据库的写权限，无法进行订单审核操作。

## 🔐 权限配置方案

### 方案一：临时开放权限（快速解决）

#### 1. 打开云数据库控制台
1. 在微信开发者工具中点击"云开发"
2. 选择"数据库"选项卡
3. 找到并点击"orders"集合

#### 2. 配置权限规则
1. 点击"权限设置"标签
2. 选择"自定义安全规则"
3. 输入以下权限配置：

```json
{
  "read": true,
  "write": true
}
```

**说明**：
- `"read": true` - 所有用户可读（查看订单列表）
- `"write": true` - 所有用户可写（创建和更新订单）

#### 3. 保存配置
点击"保存"按钮，配置立即生效。

### 方案二：基于用户身份的权限控制（推荐）

#### 1. 订单创建者权限
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

**说明**：
- 所有人可以读取订单（用于管理员查看）
- 只有订单创建者可以修改自己的订单

#### 2. 管理员权限控制（需要额外开发）
```json
{
  "read": true,
  "write": "auth.openid in ['admin_openid_1', 'admin_openid_2'] || doc._openid == auth.openid"
}
```

**说明**：需要先获取管理员的openid并配置到权限规则中。

### 方案三：完全开放（仅用于开发测试）

```json
{
  "read": true,
  "write": true,
  "create": true,
  "delete": true
}
```

⚠️ **警告**：此配置仅适用于开发测试环境，生产环境绝不能使用！

## 🛠️ 操作步骤详解

### Step 1: 进入权限设置界面
1. 微信开发者工具 → 云开发
2. 数据库 → orders集合
3. 权限设置标签

### Step 2: 修改安全规则
1. 选择"自定义安全规则"
2. 清空现有规则
3. 粘贴新的权限配置
4. 点击"保存"

### Step 3: 验证权限配置
1. 返回小程序
2. 进入订单管理页面
3. 尝试审核订单（通过/拒绝）
4. 查看是否成功

## 📋 常见权限配置说明

### 1. 基础权限字段
- `read`: 读取权限
- `write`: 写入权限（包括更新）
- `create`: 创建权限
- `delete`: 删除权限

### 2. 权限表达式
- `true`: 所有用户都有权限
- `false`: 所有用户都没有权限
- `auth.openid == 'specific_openid'`: 特定用户有权限
- `doc._openid == auth.openid`: 文档创建者有权限

### 3. 复合条件
- `||`: 或条件（满足任一条件即可）
- `&&`: 且条件（必须同时满足）
- `in`: 包含条件（检查值是否在数组中）

## 🔄 测试验证

配置完成后进行以下测试：

1. **查看订单列表** ✅
   - 进入管理后台
   - 查看是否能正常显示订单

2. **审核订单** ✅
   - 点击"通过"按钮
   - 查看订单状态是否更新为"已通过"

3. **拒绝订单** ✅
   - 点击"拒绝"按钮
   - 查看订单状态是否更新为"已拒绝"

## ⚠️ 安全注意事项

### 开发环境
- 可以使用较宽松的权限配置
- 便于开发和测试

### 生产环境
- 必须使用严格的权限控制
- 建议基于用户角色设计权限
- 定期审查权限配置

### 管理员权限
- 考虑实现专门的管理员认证
- 使用云函数进行服务端权限验证
- 避免在客户端直接操作敏感数据

## 🔍 故障排查

### 权限配置后仍然报错？
1. 检查JSON语法是否正确
2. 确认是否已保存配置
3. 重新编译小程序项目
4. 查看控制台是否有其他错误

### 部分操作有权限，部分没有？
1. 检查权限表达式的逻辑
2. 确认当前用户的openid
3. 验证文档的_openid字段

## 📞 技术支持

如果问题仍然存在：
1. 检查微信开发者工具版本
2. 查看云开发控制台的详细错误信息
3. 确认云环境状态正常
4. 参考微信官方文档的权限配置说明